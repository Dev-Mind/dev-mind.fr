:doctitle: D√©marrez un projet Typescript et testez le avec Jest
:description: Tout savoir sur comment D√©marrer un projet Typescript et le tester avec Jest
:keywords: Web, Typescript, Jest
:author: Guillaume EHRET - Dev-Mind
:revdate: 2019-08-19
:category: Web
:teaser: Toutes les √©tapes pour d√©marrer un projet TypeScript et tester son code avec Jest.
:imgteaser: :../../img/blog/2019/laissez_tomber_javascript.png
:toc:

Si vous √™tes un d√©veloppeur web, vous avez forc√©ment entendu parler de https://www.typescriptlang.org[TypeScript]. Ce langage se d√©finit comme un sur-ensemble de https://www.javascript.com/[JavaScript]. Votre code est compil√© en JavaScript standard pour pouvoir √™tre ex√©cut√© sur un moteur JavaScript (node, navigateur).

https://www.typescriptlang.org[TypeScript] comble beaucoup de manque du langage https://www.javascript.com/[JavaScript], en introduisant les types et bien d'autres fonctionnalit√©s. Avec https://www.typescriptlang.org[TypeScript] vous b√©n√©ficiez d'une meilleure exp√©rience de d√©veloppement avec une meilleure compl√©tion, une remont√©e des erreurs plus rapide... De nombreux frameworks l'ont adopt√© (https://angular.io/[Angular], https://aurelia.io/[Aurelia], https://www.nativescript.org/[NativeScript]...) car comme pour les langages C# ou Java le langage a un r√©el avantage en entreprise.

Dans cet article, nous allons voir comment lancer un projet https://www.typescriptlang.org[TypeScript], le compiler, √©x√©cuter des tests via https://jestjs.io/[Jest]. Il existe pas mal de ressources sur le web sur ce sujet mais tr√®s souvent les choses sont complexifi√©es.

== Etape 1 : NodeJS

https://www.javascript.com/[JavaScript] est un langage qui est ex√©cut√© sur un moteur JavaScript. Les navigateurs Internet int√®grent tous aujourd'hui des moteurs JavaScript. Quand vous voulez cr√©er une application en dehors d'un navigateur, vous allez utiliser NodeJs qui fournit un moteur JavaScript autonome.

https://nodejs.org/[NodeJS] est disponible pour toutes les plateformes https://nodejs.org/en/download/

https://nodejs.org/[NodeJS] fourni un gestionnaire de paquet `npm` qui permet de t√©l√©charger et mettre √† jour les d√©pendances d'un projet.

Une fois que vous avez install√© NodeJs vous lancer dans un terminal `npm`

[source, shell, subs="none"]
----
$ npm

Usage: npm <command>

where <command> is one of:
    access, adduser, audit, bin, bugs, c, cache, ci, cit,
    clean-install, clean-install-test, completion, config,
    create, ddp, dedupe, deprecate, dist-tag, docs, doctor,
    edit, explore, get, help, help-search, hook, i, init,
    install, install-ci-test, install-test, it, link, list, ln,
    login, logout, ls, org, outdated, owner, pack, ping, prefix,
    profile, prune, publish, rb, rebuild, repo, restart, root,
    run, run-script, s, se, search, set, shrinkwrap, star,
    stars, start, stop, t, team, test, token, tst, un,
    uninstall, unpublish, unstar, up, update, v, version, view,
    whoami

npm <command> -h  quick help on <command>
npm -l            display full usage info
npm help <term>   search for help on <term>
npm help npm      involved overview
----

Vous pouvez lancer la commande `node` qui permet de lancer une console node

[source, shell, subs="none"]
----
$ node
> const name = 'Guillaume'
undefined
> console.log(name)
Guillaume
>
(To exit, press ^C again or type .exit)
>
----

== Etape 2 : Cr√©er un projet

Nous allons commencer par cr√©er l'arborescence de notre projet `myproject`

[source, shell, subs="none"]
----
mkdir -p myproject/src/main/typescript
mkdir -p myproject/src/test/typescript
----

Nous allons utiliser NodeJS dans notre projet pour b√©n√©ficier du gestionnaire de paquet `npm` mais aussi ex√©cuter notre code. Pour initialiser notre projet nous allons utiliser le client fournit avec `npm`. Le client va g√©n√©rer un fichier `package.json` √† la racine de votre projet en fonction des r√©ponses que vous aurez donn√©

[source, shell, subs="none"]
----
$ cd myproject
$ npm init
This utility will walk you through creating a package.json file.
It only covers the most common items, and tries to guess sensible defaults.

See `npm help json` for definitive documentation on these fields
and exactly what they do.

Use `npm install <pkg>` afterwards to install a package and
save it as a dependency in the package.json file.

Press ^C at any time to quit.
package name: (myproject)
version: (1.0.0)
description: My first example in TypeScript
entry point: (index.js)
test command:
git repository:
keywords:
author: Guillaume EHRET
license: (ISC) MIT
About to write to /home/devmind/Workspace/web/myproject/package.json:

{
  "name": "myproject",
  "version": "1.0.0",
  "description": "My first example in TypeScript",
  "main": "index.js",
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "author": "Guillaume EHRET",
  "license": "MIT"
}
----

`npm` permet d'installer des packages et des librairies. Par exemple pour installer typescript vous lancerez


[source, shell, subs="none"]
----
npm install typescript
----

Cettte commande va ajouter un bloc `dependencies` dans le fichier `package.json`. Comme vous n'avez pas sp√©cifier de version `npm` prend la derni√®re disponible. `npm` utilise les num√©ros de version s√©mantique. Dans l'exemple ci dessous le `^` (caret) indique que `npm` t√©l√©chargera au moins une version >= 3.5.3 et < 4.0.0

[source, json, subs="none"]
----
"dependencies": {
  "typescript": "^3.5.3"
}
----

Si vous utilisez un `~` √† la place de `^`, `npm` ne pourra t√©l√©charger que les versions >= 3.5.3 et < 3.6.0
Si vous n'utilisez aucune marque `npm` chargera la version sp√©cifi√©e.

Il existe plusieurs autres possibilit√©s et vous trouverez plus d'informations sur https://semver.org/

`npm` t√©l√©charge les librairies dans le r√©pertoire `node_modules` de votre projet. Ce r√©pertoire `node_modules` ne doit jamais √™tre commit√© dans git car il peut √™tre tr√®s volumineux et on pr√©f√©rera le r√©installer lors d'un clone d'un projet via

[source, shell, subs="none"]
----
npm install
----


== Etape 2 : Installer typescript

Nous avons utilis√© `npm` dans l'√©tape pr√©c√©dente pour installer TypeScript.

Nous pouvons personnaliser la configuration TypeScript en ajoutant un fichier `tsconfig.json`. Les diff√©rentes valeurs possibles sont d√©finies sur cette https://www.typescriptlang.org/docs/handbook/tsconfig-json.html[page].

Par exemple dans notre cas nous allons pr√©ciser plusieurs options de compilation

[source, json, subs="none"]
----
{
  "compilerOptions": {
    /* Specify ECMAScript target version: 'ES3' (default). Here ES5 to be compatible with all web browsers */
    "target": "ES5",
    /* Specify module code generation: 'commonjs', 'amd', 'system', 'umd' or 'es2015'. */
    "module": "commonjs",
    /* Specify library files to be included in the compilation:  */
    "lib": [
      "esnext",
      "dom"
    ],
    /* We want to generate a sourcemap  */
    "sourceMap": true,
    /* All files will be compiled in build directory  */
    "outDir": "./build"
  },
  "include": [
      "src/**/*"
  ],
  "exclude": [
    "node_modules"
  ]
}
----

En gros avec cette configuration, nous indiquons au compilateur de prendre les fichiers TypeScript dans le r√©pertoire `src` et les compiler en EcmaScript 5 dans le r√©pertoire `build  en utilisant `commonjs` comme gestionnaire de modules.

== Etape 3 : Ecrire du code en TypeScript

Le syst√®me de types est la caract√©ristique essentielle du langage. Si vous avez une fonction

[source, typescript, subs="none"]
----
great(name: string){
    return `Hi, ${name}`;
}
----

En Javascript vous pourriez √©crire
[source, javascript, subs="none"]
----
console.log(great(123));
----

Mais en TypeScript le compilateur va retourner l'erreur "Argument type 123 is not assignable to type string". Dans les IDE vous allez avoir l'erreur au moment ou vous √©crivez votre code (ceci √©vite bon nombre de bugs). TypeScript fait aussi de l'inf√©rence de type. Dans le code ci dessous le langage d√©duit que le type de la variable `age` est un num√©rique et donc il va vous emp√™cher de lui attribuer une autre valeur. Vous aurez √©galement une erreur de type sur la deuxi√®me ligne

[source, typescript, subs="none"]
----
let age = 42;
age = "inconnu";
----

Nous allons cr√©er deux fichiers dans `src/main/typescript`. Le premier `person.ts` contiendra la d√©finition d'une interface `Person` (qui est export√©e pour pouvoir l'utiliser dans d'autres fichiers). En TypeScript vous pouvez d√©finir des https://www.typescriptlang.org/docs/handbook/interfaces.html[interfaces] et des types customs. Ceci est tr√®s pratique pour √©tendre le syst√®me de types. Nous d√©finissons aussi une https://www.typescriptlang.org/docs/handbook/classes.html[classe]  `Greater` exposant une m√©thode pour saluer une personne

[source, typescript, subs="none"]
----
export interface Person {
    firstName: string;
    lastName: string;
}

export class GreaterService {
    great(person: Person){
        return `Hi, ${person.firstName} ${person.lastName}`;
    }
}
----

Vous pouvez maintenant cr√©er un second fichier `index.ts` dans lequel nous allons importer ce que nous venons de cr√©er et l'appeler

[source, typescript, subs="none"]
----
import {GreaterService, Person} from "./person";

const person:Person = {
    firstName: 'Guillaume',
    lastName: 'EHRET'
}

console.log(new GreaterService().great(person));
----

Il ne nous reste plus qu'√† compiler (via `tsc`) notre projet et lancer `index.js` qui r√©sulte de cette compilation (dans notre fichier de configuration TypeScript nous avon pr√©ciser que le r√©pertoire de compilation √©tait `build`).

[source, shell, subs="none"]
----
$ tsc
$ node build/index.js
----

Cet exemple est simpliste mais permet de voir rapidement comment le langage fonctionne. Pour d√©marrer sur TypeScript je vous conseille la https://www.typescriptlang.org/docs/home.html[documentation officielle] qui n'est pas trop mal faite √† mon sens.

== Etape 4 : Tester notre code avec Jest

Il existe de nombreuses librairies pour √©crire des tests de votre code JavaScript ou TypeScript. https://jestjs.io/[Jest] a √©t√© cr√©√© par Facebook pour ses projets https://reactjs.org/[React] et le but est d'√™tre le plus simple possible tout en √©tant le plus performant. Au final vous pouvez utiliser Jest dans d'autres projets que des projets React et c'est ce que nous allons faire.

Nous allons √©crire des tests unitaires pour v√©rifier le comportement de chaque partie de notre code. Quand une portion de code a des d√©pendances vers d'autres parties nous allons utiliser des mocks pour simuler le fonctionnement de ces d√©pendances.


*Comment installer Jest*

Nous devons installer le package principal et celui d√©di√© √† TypeScript

[source, shell, subs="none"]
----
npm install jest @types/jest ts-jest -D
----


Pour param√©trer Jest nous allons utiliser le client

[source, shell, subs="none"]
----
jest --init

‚úî Would you like to use Jest when running "test" script in "package.json"? ‚Ä¶ yes
‚úî Choose the test environment that will be used for testing ‚Ä∫ node
‚úî Do you want Jest to add coverage reports? ‚Ä¶ yes
‚úî Automatically clear mock calls and instances between every test? ‚Ä¶ yes


‚úèÔ∏è  Modified /home/devmind/Workspace/web/dev-mind.fr/package.json
üìù  Configuration file created at /home/devmind/Workspace/web/dev-mind.fr/jest.config.js
----

Jest a √©t√© con√ßu pour ex√©cuter par d√©faut du JavaScript. Pour param√©trer vos tests en TypeScript vous allez devoir modifier le fichier de configuration `jest.config.js`

[source, json, subs="none"]
----
[source, shell, subs="none"]
transform:  {
"\\.(ts)$": "ts-jest"
},
----


Si vous voulez lancer les tests via `yarn test` ou `npm run test` vous pouvez modifier votre fichier `package.json`
[source, json, subs="none"]
----
"scripts": {
  "test": "jest"
},
----

*Utiliser Jest*

Nous allons tester le code typescript que nous avons √©crit plus haut. Pour cel√† cr√©ons `person.spec.ts` dans le r√©pertoire `src/test/typescript`. La syntaxe jasmine est disponible si vous souhaitez par exemple migrer votre suite de tests existantes. Mais les https://jestjs.io/docs/en/using-matchers[assertions] sont l√©g√©√®rement diff√©rentes

[source, typescript, subs="none"]
----
import {GreaterService, Person} from "../../main/typescript/person";

describe('Test person.ts', () => {
    let service: GreaterService;

    beforeEach(() => service = new GreaterService());

    test('should say', () => {
        const person: Person = {
            firstName: 'Guillaume',
            lastName: 'EHRET'
        };
        expect(service.great(person)).toBe('Hi, Guillaume EHRET');
    })
});
----

Vous pouvez maintenant la lancer la commande `jest` pour ex√©cuter vos tests. Jest permet aussi de https://jestjs.io/docs/en/mock-functions.html[mocker] les d√©pendances d'une classe. Vous pouvez √©galement appeler du code https://jestjs.io/docs/en/asynchronous[asynchrone] dans vos tests.


*Couverture du code par les tests*

Jest comprend tout ce qu'il faut pour v√©rifier que votre code est bien tester. Vous pouvez ajouter l'option `--coverage` ppour g√©n√©rer un rapport

[source, shell, subs="none"]
----
devmind@devmind:~/Workspace/web/myproject$ jest --coverage
PASS  src/test/typescript/person.spec.ts
Test person.ts
‚úì should say (4ms)

-----------|----------|----------|----------|----------|-------------------|
File       |  % Stmts | % Branch |  % Funcs |  % Lines | Uncovered Line #s |
-----------|----------|----------|----------|----------|-------------------|
All files  |      100 |      100 |      100 |      100 |                   |
person.ts  |      100 |      100 |      100 |      100 |                   |
-----------|----------|----------|----------|----------|-------------------|
Test Suites: 1 passed, 1 total
Tests:       1 passed, 1 total
Snapshots:   0 total
Time:        1.358s, estimated 2s
Ran all test suites.
----

== Conclusion

Vous pouvez donc maintenant commencer √† coder en https://www.typescriptlang.org/docs/home.html[TypeScript] et tester votre code avec Jest. Je vous ai laiss√© les diff√©rents points d'entr√©e si vous voulez aller plus loin.

Au niveau des tests unitaires https://jestjs.io/[Jest] est beaucoup plus rapide que Karma car les tests ne sont pas lanc√©s dans un navigateur headless ou non



